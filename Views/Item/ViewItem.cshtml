@model Item
@{
	string itemName = Model.Name;
	ViewData["Title"] = itemName;
}

<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

</head>
<body>
	<!--Main info about item -->
	<div class="container mt-5">
		<div class="card shadow-lg border-0 rounded-4">
			<div class="row g-0">
				<div class="col-md-5">
					<img src="@Model.ImageUrl" class="img-fluid rounded-start" alt="@Model.Name">
				</div>
				<div class="col-md-7">
					<div class="card-body">
						<h2 class="card-title text-primary">@Model.Name</h2>
						<h5 class="text-muted mb-3">@Model.Category</h5>
						<p class="card-text">@Model.Description</p>
						<h4 class="text-success fw-bold">Price: $@Model.Price</h4>

						<div class="mt-4 d-flex gap-2">
							<button class="btn btn-outline-primary btn-add-to-cart" data-id="@Model.Id">
								<i class="bi bi-cart-plus"></i> Add to Cart
							</button>
							<a asp-controller="Item" asp-action="Index" class="btn btn-secondary">← Back to Shop</a>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- review submission form -->
	<div class="card mt-4 shadow-sm">
		<div class="card-body">
			<h4 class="card-title">Add Your Review</h4>
			@if (User.Identity.IsAuthenticated)
			{
				@Html.AntiForgeryToken()
				<form id="reviewForm">
					<input type="hidden" name="itemId" value="@Model.Id" />
					<div class="mb-3">
						<label class="form-label">Rating:</label>
						<div class="star-rating">
							@for (int i = 5; i >= 1; i--)
							{
								<input type="radio" name="rating" id="star-@i" value="@i" required />
								<label for="star-@i" class="bi bi-star-fill mx-1"></label>
							}
						</div>
					</div>
					<div class="mb-3">
						<label for="comment" class="form-label">Comment (optional):</label>
						<textarea class="form-control" id="comment" name="comment" rows="4"></textarea>
					</div>
					<button type="submit" class="btn btn-primary">Submit Review</button>
				</form>
			}
			else
			{
				<p>Please <a asp-area="Identity" asp-page="/Account/Login">log in</a> to submit a review.</p>
			}
		</div>
	</div>

	<!-- Display existing reviews -->
	<div class="card mt-4 shadow-sm">
		<div class="card-body">
			<h4 class="card-title">Reviews</h4>
			@if (Model.Reviews.Count > 0)
			{
				foreach (var review in Model.Reviews)
				{
					<div class="review mb-3 p-3 border rounded">
						<div class="d-flex justify-content-between">
							<span><strong>User:</strong> @(review.UserEmail)</span>
							<span><strong>Rating:</strong> @string.Concat(Enumerable.Repeat("★", (int)review.Rating))</span>
						</div>
						@if (!string.IsNullOrEmpty(review.Comment))
						{
							<p class="mt-2"><strong>Comment:</strong> @review.Comment</p>
						}
						<small class="text-muted">Posted on: @review.CreatingDate.ToString("g")</small>
					</div>
				}
			}
			else
			{
				<p>No reviews yet. Be the first to leave a review!</p>
			}
		</div>
	</div>
	@section Scripts {
		<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
		<script>
			$(document).ready(function () {
				//star rating interaction
				$('.star-rating label').hover(
					function () {
						$(this).addClass('selected');
						$(this).prevAll('.bi-star-fill').addClass('selected');
					},
					function () {
						$('.star-rating .bi-star-fill').removeClass('selected');
						$('.star-rating input:checked').next('.bi-star-fill').addClass('selected');
						$('.star-rating input:checked').next('.bi-star-fill').prevAll('.bi-star-fill').addClass('selected');
					}
				);

				$('.star-rating input').change(function () {
					$('.star-rating .bi-star-fill').removeClass('selected');
					$(this).next('.bi-star-fill').addClass('selected');
					$(this).next('.bi-star-fill').prevAll('.bi-star-fill').addClass('selected');
				});

				// AJAX for review submission
				$('#reviewForm').submit(function (e) {
					e.preventDefault();
					var formData = $(this).serialize();
					var token = $("input[name='__RequestVerificationToken']").val();

					$.ajax({
						url: '/Item/AddReview',
						type: 'POST',
						data: formData,
						headers: {
							RequestVerificationToken: token
						},
						success: function (response) {
							if (response.success) {
								//alert(response.message);
								location.reload(); // Reload to show new review
							} else {
								alert(response.message);
							}
						},
						error: function (xhr) {
							alert("An error occurred: " + xhr.statusText);
						}
					});
				});

				// AJAX for Add to Cart 
				$(".btn-add-to-cart").click(function (e) {
					e.preventDefault();
					var itemId = $(this).data("id");
					var token = $("input[name='__RequestVerificationToken']").val();

					$.ajax({
						url: '/Item/Buy',
						type: 'POST',
						data: { itemId: itemId },
						headers: {
							RequestVerificationToken: token
						},
						success: function (response) {
							
						},
						error: function (xhr) {
							alert("An error occurred: " + xhr.statusText);
						}
					});
				});
			});
		</script>
	}
</body>
</html>
